from typing import Dict, List
import html


class BlockRenderer:

    def __init__(self):
        pass

    # =========================
    # Utilities
    # =========================

    def _escape_html(self, text: str) -> str:
        return html.escape(text, quote=False)

    # =========================
    # Rich Text Rendering
    # =========================

    def render_rich_text(self, rich_text: List[Dict], preserve_newlines: bool = False) -> str:
        """
        Render Notion rich_text array.
        preserve_newlines=True:
            Do NOT convert \n to <br>
        preserve_newlines=False:
            Convert \n to <br>
        """

        if not rich_text:
            return ""

        html_parts = []

        for text_obj in rich_text:
            content = text_obj.get("plain_text", "")
            annotations = text_obj.get("annotations", {})
            href = text_obj.get("href")

            content = self._escape_html(content)

            # Inline code
            if annotations.get("code"):
                content = f"<code>{content}</code>"
            else:
                if not preserve_newlines:
                    content = content.replace("\n", "<br>")

                if annotations.get("bold"):
                    content = f"<strong>{content}</strong>"

                if annotations.get("italic"):
                    content = f"<em>{content}</em>"

                if annotations.get("strikethrough"):
                    content = f"<del>{content}</del>"

                if annotations.get("underline"):
                    content = f"<u>{content}</u>"

            if href:
                content = f'<a href="{href}" target="_blank">{content}</a>'

            html_parts.append(content)

        return "".join(html_parts)

    # =========================
    # Block Renderers
    # =========================

    def _render_paragraph(self, data: Dict) -> str:
        text = self.render_rich_text(data.get("rich_text", []))
        return f"<p>{text}</p>"

    def _render_heading_1(self, data: Dict) -> str:
        text = self.render_rich_text(data.get("rich_text", []))
        return f"<h1>{text}</h1>"

    def _render_heading_2(self, data: Dict) -> str:
        text = self.render_rich_text(data.get("rich_text", []))
        return f"<h2>{text}</h2>"

    def _render_heading_3(self, data: Dict) -> str:
        text = self.render_rich_text(data.get("rich_text", []))
        return f"<h3>{text}</h3>"

    # =========================
    # Code Block (FIXED)
    # =========================

    def _render_code(self, data: Dict) -> str:
        """
        Preserve raw newlines.
        Do NOT convert to <br>.
        """

        rich = data.get("rich_text", []) or []
        raw = "".join([x.get("plain_text", "") for x in rich])

        escaped = self._escape_html(raw)

        return f"""
<div class="code-block">
<pre><code>{escaped}</code></pre>
</div>
"""

    # =========================
    # Quote Block (FIXED)
    # =========================

    def _render_quote(self, data: Dict) -> str:
        """
        Preserve newline exactly as in Notion.
        Use <pre> with pre-wrap to keep formatting.
        """

        text = self.render_rich_text(
            data.get("rich_text", []),
            preserve_newlines=True
        )

        return f"""
<blockquote>
<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">
{text}
</pre>
</blockquote>
"""

    # =========================
    # Callout Block (FIXED)
    # =========================

    def _render_callout(self, data: Dict) -> str:
        text = self.render_rich_text(
            data.get("rich_text", []),
            preserve_newlines=True
        )

        icon = data.get("icon", {})
        icon_html = ""

        if icon.get("type") == "emoji":
            icon_html = f'<span class="callout-icon">{icon.get("emoji", "")}</span>'

        return f"""
<div class="callout">
{icon_html}
<div class="callout-content">
<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">
{text}
</pre>
</div>
</div>
"""

    # =========================
    # Dispatch
    # =========================

    def render(self, block: Dict) -> str:

        block_type = block.get("type")
        data = block.get(block_type, {})

        method = getattr(self, f"_render_{block_type}", None)

        if method:
            return method(data)

        return ""
