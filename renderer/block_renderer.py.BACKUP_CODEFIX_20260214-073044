from .config import DELIMITERS as delimiters
delimiters = set(' \t\r\n,.;:!?()[]{}<>"\'â€œâ€â€˜â€™ã€ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿï¼ˆï¼‰ã€ã€‘ã€Šã€‹-â€“â€”_/\\|')
#!/usr/bin/env python3
"""
INTRA-HUB v1.0 - Notion Block Renderer
Renders Notion content blocks to high-fidelity HTML
"""

import json
import logging
from pathlib import Path
from typing import Dict, List, Any, Optional

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class NotionBlockRenderer:
    """Renders individual Notion blocks to HTML"""
    
    def __init__(self):
        pass
    
    def render_rich_text(self, rich_text: List[Dict]) -> str:
        """Render Notion rich text with formatting, preserving line breaks"""
        if not rich_text:
            return ''
        
        html = []
        for text_obj in rich_text:
            content = text_obj.get('plain_text', '')
            annotations = text_obj.get('annotations', {})
            
            # Apply formatting
            if annotations.get('code'):
                # For code, escape first, then preserve line breaks
                escaped = self._escape_html(content)
                content = f'<code>{escaped.replace(chr(10), "<br>")}</code>'
            else:
                # For non-code text, preserve line breaks first
                content = content.replace('\n', '<br>')
                
                if annotations.get('bold'):
                    content = f'<strong>{content}</strong>'
                if annotations.get('italic'):
                    content = f'<em>{content}</em>'
                if annotations.get('strikethrough'):
                    content = f'<del>{content}</del>'
                if annotations.get('underline'):
                    content = f'<u>{content}</u>'
            
            # Handle links
            if text_obj.get('href'):
                content = f'<a href="{text_obj["href"]}" target="_blank">{content}</a>'
            
            html.append(content)
        
        return ''.join(html)
    
    def _escape_html(self, text: str) -> str:
        """Escape HTML special characters"""
        return (text
                .replace('&', '&amp;')
                .replace('<', '&lt;')
                .replace('>', '&gt;')
                .replace('"', '&quot;')
                .replace("'", '&#39;'))
    
    def render_block(self, block: Dict) -> str:
        """Render a single Notion block to HTML"""
        block_type = block.get('type')
        block_data = block.get(block_type, {})
        
        try:
            if block_type == 'paragraph':
                return self._render_paragraph(block_data)
            elif block_type == 'heading_1':
                return self._render_heading(block_data, 1)
            elif block_type == 'heading_2':
                return self._render_heading(block_data, 2)
            elif block_type == 'heading_3':
                return self._render_heading(block_data, 3)
            elif block_type == 'bulleted_list_item':
                return self._render_list_item(block_data, 'ul')
            elif block_type == 'numbered_list_item':
                return self._render_list_item(block_data, 'ol')
            elif block_type == 'to_do':
                return self._render_todo(block_data)
            elif block_type == 'toggle':
                return self._render_toggle(block_data)
            elif block_type == 'code':
                return self._render_code(block_data)
            elif block_type == 'quote':
                return self._render_quote(block_data)
            elif block_type == 'callout':
                return self._render_callout(block_data)
            elif block_type == 'divider':
                return '<hr class="divider" />'
            elif block_type == 'table':
                return self._render_table(block)
            elif block_type == 'image':
                return self._render_image(block_data)
            elif block_type == 'file':
                return self._render_file(block_data)
            elif block_type == 'equation':
                return self._render_equation(block_data)
            else:
                # Unknown block - render as plain text
                return self._render_unknown(block_type, block_data)
                
        except Exception as e:
            logger.error(f"Error rendering block type '{block_type}': {e}")
            return f'<div class="render-error">Error rendering {block_type} block</div>'
    
    def _render_paragraph(self, data: Dict) -> str:
        """Render paragraph block"""
        text = self.render_rich_text(data.get('rich_text', []))
        if not text:
            return '<p class="empty-paragraph">&nbsp;</p>'
        return f'<p>{text}</p>'
    
    def _render_heading(self, data: Dict, level: int) -> str:
        """Render heading block"""
        text = self.render_rich_text(data.get('rich_text', []))
        return f'<h{level}>{text}</h{level}>'
    
    def _render_list_item(self, data: Dict, list_type: str) -> str:
        """Render list item (will be grouped by parent renderer)"""
        text = self.render_rich_text(data.get('rich_text', []))
        return f'<li>{text}</li>'
    
    def _render_todo(self, data: Dict) -> str:
        """Render to-do item"""
        text = self.render_rich_text(data.get('rich_text', []))
        checked = data.get('checked', False)
        checkbox = 'â˜‘' if checked else 'â˜'
        checked_class = 'checked' if checked else ''
        return f'<div class="todo-item {checked_class}"><span class="checkbox">{checkbox}</span> {text}</div>'
    
    def _render_toggle(self, data: Dict) -> str:
        """Render toggle block"""
        text = self.render_rich_text(data.get('rich_text', []))
        return f'<details class="toggle"><summary>{text}</summary></details>'
    
    def _render_code(self, data: Dict) -> str:
        """Render code block with proper escaping - Notion style (no language label)"""
        code_text = self.render_rich_text(data.get('rich_text', []))
        language = data.get('language', 'plaintext')
        
        # Fully escape code content
        escaped_code = self._escape_html(code_text)
        
        # Notion-style code block with light background - NO language header
        return f'''<div class="code-block">
<pre><code class="language-{language}">{escaped_code}</code></pre>
</div>'''
    
    def _render_quote(self, data: Dict) -> str:
        """Render quote block"""
        text = self.render_rich_text(data.get('rich_text', []))
        return f'<blockquote>{text}</blockquote>'
    
    def _render_callout(self, data: Dict) -> str:
        """Render callout block"""
        text = self.render_rich_text(data.get('rich_text', []))
        icon = data.get('icon', {})
        
        icon_html = ''
        if icon.get('type') == 'emoji':
            icon_html = f'<span class="callout-icon">{icon.get("emoji", "ðŸ’¡")}</span>'
        
        return f'<div class="callout">{icon_html}<div class="callout-content">{text}</div></div>'
    
    def _render_table(self, block: Dict) -> str:
        """Render table block with full support for child table_row blocks"""
        table_data = block.get('table', {})
        has_column_header = table_data.get('has_column_header', False)
        has_row_header = table_data.get('has_row_header', False)
        table_width = table_data.get('table_width', 0)
        
        # Get child blocks (table rows)
        children = block.get('children', [])
        
        if not children:
            return f'''<div class="table-wrapper">
<table class="notion-table">
<tbody>
<tr><td colspan="{table_width}" class="table-placeholder">Empty table</td></tr>
</tbody>
</table>
</div>'''
        
        # Build table HTML
        rows_html = []
        is_first_row = True
        
        for child in children:
            if child.get('type') == 'table_row':
                row_data = child.get('table_row', {})
                cells = row_data.get('cells', [])
                
                # Determine if this row should be header
                use_th = (is_first_row and has_column_header)
                tag = 'th' if use_th else 'td'
                
                cells_html = []
                for i, cell in enumerate(cells):
                    # Each cell contains rich_text array
                    cell_content = self.render_rich_text(cell)
                    if not cell_content:
                        cell_content = '&nbsp;'
                    
                    # First column as header if has_row_header
                    if i == 0 and has_row_header and not use_th:
                        cells_html.append(f'<th>{cell_content}</th>')
                    else:
                        cells_html.append(f'<{tag}>{cell_content}</{tag}>')
                
                row_html = '<tr>' + ''.join(cells_html) + '</tr>'
                rows_html.append(row_html)
                
                is_first_row = False
        
        table_html = '\n'.join(rows_html)
        
        # Wrap in table structure
        if has_column_header and rows_html:
            # First row is header
            return f'''<div class="table-wrapper">
<table class="notion-table">
<thead>
{rows_html[0]}
</thead>
<tbody>
{''.join(rows_html[1:]) if len(rows_html) > 1 else '<tr><td colspan="' + str(table_width) + '">&nbsp;</td></tr>'}
</tbody>
</table>
</div>'''
        else:
            return f'''<div class="table-wrapper">
<table class="notion-table">
<tbody>
{table_html}
</tbody>
</table>
</div>'''
    
    def _render_image(self, data: Dict) -> str:
        """Render image block"""
        image_type = data.get('type')
        url = ''
        
        if image_type == 'external':
            url = data.get('external', {}).get('url', '')
        elif image_type == 'file':
            url = data.get('file', {}).get('url', '')
        
        caption = self.render_rich_text(data.get('caption', []))
        
        if url:
            caption_html = f'<figcaption>{caption}</figcaption>' if caption else ''
            return f'<figure class="image-block"><img src="{url}" alt="{caption}" />{caption_html}</figure>'
        
        return '<div class="image-placeholder">Image unavailable</div>'
    
    def _render_file(self, data: Dict) -> str:
        """Render file/download block"""
        file_type = data.get('type')
        url = ''
        
        if file_type == 'external':
            url = data.get('external', {}).get('url', '')
        elif file_type == 'file':
            url = data.get('file', {}).get('url', '')
        
        caption = self.render_rich_text(data.get('caption', []))
        name = caption or 'Download File'
        
        if url:
            return f'<div class="file-download"><a href="{url}" download class="download-link">ðŸ“Ž {name}</a></div>'
        
        return '<div class="file-placeholder">File unavailable</div>'
    
    def _render_equation(self, data: Dict) -> str:
        """Render mathematical equation - KaTeX will auto-render $$...$$ format"""
        expression = data.get('expression', '')
        # CRITICAL: Do NOT escape HTML - KaTeX needs raw LaTeX
        # Use $$ delimiters for display math (block equation)
        return f'<div class="equation">$${expression}$$</div>'
    
    def _render_unknown(self, block_type: str, data: Dict) -> str:
        """Render unknown block type as plain text"""
        # Try to extract any rich_text content
        rich_text = data.get('rich_text', [])
        if rich_text:
            text = self.render_rich_text(rich_text)
            return f'<div class="unknown-block" data-type="{block_type}">{text}</div>'
        
        return f'<div class="unknown-block" data-type="{block_type}">Unsupported block: {block_type}</div>'

